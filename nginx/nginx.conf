events {
  worker_connections 1024;
}

http {
  include       mime.types;
  default_type  application/octet-stream;
  sendfile      on;
  keepalive_timeout 65;

  # Allow large HLS segment transfers
  client_max_body_size 0;

  # Upstream services
  upstream backend  { server backend:3001; }
  upstream mediamtx { server mediamtx:8888; }
  upstream mediamtx_webrtc { server mediamtx:8889; }
  upstream frontend { server frontend:80; }

  server {
    listen 80;
    server_name _;

    # ── REST API → Node.js backend ─────────────────────────
    location /api/ {
      proxy_pass         http://backend;
      proxy_http_version 1.1;
      proxy_set_header   Host              $host;
      proxy_set_header   X-Real-IP         $remote_addr;
      proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header   Upgrade $http_upgrade;
      proxy_set_header   Connection "upgrade";
    }

    # ── HLS segments → MediaMTX ────────────────────────────
    location /hls/ {
      # Strip /hls prefix before forwarding to MediaMTX
      rewrite ^/hls/(.*)$ /$1 break;
      proxy_pass         http://mediamtx;
      proxy_http_version 1.1;
      proxy_set_header   Host $host;

      # Required CORS headers for HLS.js to load segments
      add_header Access-Control-Allow-Origin  *;
      add_header Access-Control-Allow-Methods 'GET, OPTIONS';
      add_header Cache-Control               'no-cache';
    }

    # ── WebRTC (WHIP/WHEP) → MediaMTX ──────────────────────
    location /webrtc/ {
      # Strip /webrtc prefix before forwarding to MediaMTX
      rewrite ^/webrtc/(.*)$ /$1 break;
      proxy_pass         http://mediamtx_webrtc;
      proxy_http_version 1.1;
      proxy_set_header   Host $host;

      # Required CORS headers for WebRTC SDP exchange
      add_header Access-Control-Allow-Origin '*';
      add_header Access-Control-Allow-Methods 'OPTIONS, GET, POST, PATCH, PUT, DELETE';
      add_header Access-Control-Allow-Headers 'Content-Type, Authorization';

      # Respond directly to OPTIONS requests (CORS preflight)
      if ($request_method = OPTIONS) {
          add_header Content-Length 0;
          add_header Content-Type text/plain;
          return 204;
      }
    }

    # ── React SPA → Frontend container ────────────────────
    location / {
      proxy_pass         http://frontend;
      proxy_http_version 1.1;
      proxy_set_header   Host $host;
    }
  }
}
